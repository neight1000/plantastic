<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plantasia â€“ Instrumentation Tribute</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Accessibility: Improved color contrast, font size, and variables for easier theming -->
  <style>
    :root {
      --primary-color: #00ffe0;
      --accent-color: #0ffea0;
      --wave-color: #00FF7F;
      --background-color: #000;
      --surface-color: #232323;
      --surface-alpha: rgba(0, 0, 0, 0.92);
      --font-family: monospace, monospace;
      --btn-radius: 8px;
      --shadow: 0 1px 8px #000b;
      --border: 1.5px solid var(--primary-color);
      --focus-outline: 2px solid #fff;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: #fff;
      font-family: var(--font-family);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    #waveCanvas {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0;
      display: block;
      background: var(--background-color);
    }
    /* Accessibility: visually hides canvas for screen readers, but provides alt text */
    #waveCanvas[aria-label] {
      outline: none;
    }
    .ui {
      position: absolute;
      bottom: 0;
      width: 100vw;
      background: var(--surface-alpha);
      padding: 18px 0 10px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-end;
      gap: 18px 16px;
      z-index: 2;
      border-radius: 28px 28px 0 0;
      box-shadow: 0 -2px 32px #000c;
      transition: transform 0.22s cubic-bezier(.87,0,.13,1);
    }
    .ui.closed {
      transform: translateY(105%);
      pointer-events: none;
    }
    .ui.open {
      transform: translateY(0%);
      pointer-events: auto;
    }
    .drawer-toggle-btn {
      position: fixed;
      right: 24px;
      bottom: 26px;
      z-index: 10;
      background: var(--surface-color);
      color: #fff;
      border: var(--border);
      border-radius: var(--btn-radius);
      width: 42px;
      height: 42px;
      font-size: 22px;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.14s, color 0.14s, border 0.14s;
      outline: none;
    }
    .drawer-toggle-btn.open { background: #232323; color: var(--accent-color); border-color: var(--accent-color); }
    .drawer-toggle-btn:focus { outline: var(--focus-outline); }
    #closeDrawer {
      position: absolute;
      top: 7px; right: 17px; z-index: 20;
      width: 32px; height: 32px; border-radius: var(--btn-radius); border: none;
      background: #171717; color: #fff; font-size: 18px; cursor: pointer; font-family: monospace;
      display: flex; align-items: center; justify-content: center;
    }
    #closeDrawer:focus { outline: var(--focus-outline); }
    #infoDisplay {
      position: absolute;
      top: 18px;
      left: 16px;
      z-index: 3;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 13px;
      padding: 14px 17px 14px 15px;
      display: none;
      border-radius: 9px;
      white-space: pre;
      letter-spacing: 0.4px;
      border: 1.5px solid #222;
      box-shadow: 0 2px 18px #000c;
      max-width: 80vw;
    }
    .mod-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 8px;
    }
    .mod-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 7px;
    }
    .mod-row label {
      font-size: 12px;
    }
    /* MIDI visual feedback */
    #midiIndicator {
      position: fixed;
      left: 24px;
      bottom: 24px;
      z-index: 20;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: #222;
      border: 2px solid var(--primary-color);
      box-shadow: 0 0 10px #000a;
      transition: background 0.2s;
    }
    #midiIndicator.active {
      background: var(--primary-color);
      box-shadow: 0 0 20px var(--primary-color);
    }
    /* Responsive */
    @media (max-width:700px) {
      .ui { flex-direction:column; align-items:stretch; max-width:99vw; min-width:90vw; border-radius: 20px 20px 0 0; }
      .ui > div { margin:0 0 8px 0; }
      .ui input[type="range"], .ui select { width: 80vw; }
      .ui button { min-width: 90vw; }
      .drawer-toggle-btn { width: 44px; height: 44px; font-size: 28px; }
    }
    /* Focus states for accessibility */
    select:focus, input[type="range"]:focus, button:focus {
      outline: var(--focus-outline);
    }
  </style>
</head>
<body>
<canvas id="waveCanvas" aria-label="Waveform visualizer" tabindex="-1"></canvas>
<div id="midiIndicator" title="MIDI Activity" aria-hidden="true"></div>
<div id="infoDisplay" aria-live="polite"></div>
<button id="openDrawer" class="drawer-toggle-btn" title="Open controls" aria-label="Open controls" tabindex="0">&#9776;</button>
<div class="ui closed" id="drawer" aria-label="Controls Panel">
  <button id="closeDrawer" title="Close controls" aria-label="Close controls" tabindex="0">&#215;</button>
  <div>
    <label for="preset">Preset</label>
    <select id="preset" aria-label="Preset">
      <option value="plants">Plants</option>
      <option value="mold">Mold</option>
      <option value="bacteria">Bacteria</option>
      <option value="mushrooms">Mushrooms</option>
      <option value="harmony">Lifeform Harmony</option>
      <option value="plantasiaClassic">Plantasia Classic</option>
      <option value="greenhouse">Greenhouse Lush</option>
      <option value="cosmicdew">Cosmic Dew</option>
      <option value="daybeam">Daybeam</option>
      <option value="spiralback">Spiral Back</option>
      <option value="rockflora">Planet Rockflora</option>
      <option value="mycomurk">Myco-Murk</option>
      <option value="microburst">Microburst</option>
      <option value="fibonaccishift">Fibonacci Shift</option>
    </select>
  </div>
  <div>
    <label for="waveformSelect">OSC/WAVE</label>
    <select id="waveformSelect" aria-label="Waveform">
      <option value="triangle">Triangle</option>
      <option value="sine">Sine</option>
      <option value="square">Square</option>
      <option value="sawtooth">Sawtooth</option>
    </select>
  </div>
  <div>
    <label for="delay">Delay</label>
    <input type="range" id="delay" min="0.01" max="2.0" step="0.01" value="0.6" aria-label="Delay (seconds)" />
  </div>
  <div>
    <label for="echo">Echo</label>
    <input type="range" id="echo" min="0" max="1.0" step="0.01" value="0.4" aria-label="Echo amount" />
  </div>
  <div>
    <label for="filter">Filter</label>
    <input type="range" id="filter" min="100" max="8000" step="10" value="1200" aria-label="Filter frequency (Hz)" />
  </div>
  <div>
    <label for="freq">Frequency</label>
    <input type="range" id="freq" min="50" max="1000" step="1" value="174" aria-label="Frequency (Hz)" />
  </div>
  <div>
    <label for="volume">Volume</label>
    <input type="range" id="volume" min="0" max="100" value="60" aria-label="Volume" />
  </div>
  <div>
    <label for="bpm">BPM</label>
    <input type="range" id="bpm" min="40" max="180" value="90" aria-label="Beats per minute" />
  </div>
  <div>
    <label for="midiChannelSelect">Midi Ch</label>
    <select id="midiChannelSelect" aria-label="MIDI Channel">
      <option value="-1">all</option>
      <option value="0">1</option>
      <option value="1">2</option>
      <option value="2">3</option>
      <option value="3">4</option>
      <option value="4">5</option>
      <option value="5">6</option>
      <option value="6">7</option>
      <option value="7">8</option>
      <option value="8">9</option>
      <option value="9">10</option>
      <option value="10">11</option>
      <option value="11">12</option>
      <option value="12">13</option>
      <option value="13">14</option>
      <option value="14">15</option>
      <option value="15">16</option>
    </select>
  </div>
  <div class="mod-section">
    <div class="mod-row">
      <label for="lfoRate">LFO Rate</label>
      <input type="range" id="lfoRate" min="0.01" max="10" step="0.01" value="0.18" style="width: 70px;" aria-label="LFO Rate (Hz)" />
      <span id="lfoRateValue">0.18</span> Hz
    </div>
    <div class="mod-row">
      <label for="lfoAmt">LFO Amt</label>
      <input type="range" id="lfoAmt" min="0" max="1200" step="1" value="180" style="width: 70px;" aria-label="LFO Amount" />
      <span id="lfoAmtValue">180</span>
    </div>
    <div class="mod-row">
      <label for="lfoDest">LFO Dest</label>
      <select id="lfoDest" aria-label="LFO Destination">
        <option value="filter">Filter</option>
        <option value="pitch">Pitch</option>
        <option value="pan">Pan</option>
      </select>
    </div>
  </div>
  <button id="play" aria-label="Play (space)" title="Play (space)">PLAY</button>
  <button id="stop" aria-label="Stop" title="Stop">STOP</button>
  <button id="toggleDisplay" aria-label="Show instrument data" title="Show instrument data">DATA</button>
  <button id="toggleMidiIn" aria-label="Toggle MIDI input" title="Toggle MIDI input">midi</button>
</div>
<!-- Loading indicator for audio context -->
<div id="loading" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111c;padding:2em 3em;color:#fff;border-radius:1em;z-index:99;font-size:1.3em;">Loading...</div>

<script>
/**
 * Accessibility: Allow keyboard navigation to all controls
 * Save/restore user settings (preset, BPM, volume, etc.)
 * Debounced input handlers for sliders
 * MIDI input visual feedback
 * Error handling for audio/MIDI context
 */

const $ = id => document.getElementById(id);

const drawer = $("drawer");
const openDrawerBtn = $("openDrawer");
const closeDrawerBtn = $("closeDrawer");
const loadingIndicator = $("loading");
const midiIndicator = $("midiIndicator");
const infoDisplay = $("infoDisplay");
let midiFeedbackTimeout = null;

function showLoading(show) {
  loadingIndicator.style.display = show ? 'block' : 'none';
}

// Drawer logic
function openDrawer() {
  drawer.classList.remove('closed');
  drawer.classList.add('open');
  openDrawerBtn.style.display = 'none';
  closeDrawerBtn.focus();
}
function closeDrawer() {
  drawer.classList.remove('open');
  drawer.classList.add('closed');
  openDrawerBtn.style.display = '';
  openDrawerBtn.focus();
}
openDrawerBtn.addEventListener('click', openDrawer);
closeDrawerBtn.addEventListener('click', closeDrawer);
// Keyboard support for drawer toggle
openDrawerBtn.addEventListener('keydown', e => { if (e.key === "Enter" || e.key === " ") openDrawer(); });
closeDrawerBtn.addEventListener('keydown', e => { if (e.key === "Enter" || e.key === " ") closeDrawer(); });

// Accessibility: trap focus inside the drawer when open
drawer.addEventListener('keydown', function(e) {
  if (e.key === "Tab") {
    const focusables = drawer.querySelectorAll('button, select, input[type="range"]');
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault(); last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault(); first.focus();
    }
  }
});

// --- Instrumentation parameters per preset ---
// (Same as before, truncated for brevity -- keep your full presetSettings here)
const presetSettings = {/* ... same as before ... */};

// User settings persistence
function saveSettings() {
  const settings = {
    preset: $("preset").value,
    bpm: $("bpm").value,
    volume: $("volume").value,
    waveform: $("waveformSelect").value
    // Add more as needed
  };
  localStorage.setItem("plantasticSettings", JSON.stringify(settings));
}
function loadSettings() {
  try {
    const settings = JSON.parse(localStorage.getItem("plantasticSettings") || '{}');
    if (settings.preset) $("preset").value = settings.preset;
    if (settings.bpm) $("bpm").value = settings.bpm;
    if (settings.volume) $("volume").value = settings.volume;
    if (settings.waveform) $("waveformSelect").value = settings.waveform;
  } catch {}
}
window.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  // Debounced slider handlers
  ["delay","echo","filter","freq","volume","bpm","lfoRate","lfoAmt"].forEach(id => {
    const el = $(id);
    if (!el) return;
    let timer = null;
    el.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        saveSettings();
        if (id === "volume" && masterGain) masterGain.gain.value = parseFloat(el.value) / 100;
        if (id === "bpm" && !stopped) {
          bpm = Math.round(el.value);
          scheduleNotes(getScaleFromPreset());
        }
        if (infoDisplay.style.display !== "none") updateDisplay();
      }, 50);
    });
  });
});

// Main audio, MIDI, and UI logic
let audioCtx, analyser, masterGain, reverbNode, bufferLength, dataArray;
let bpm = 90, bpmTimer = null, stopped = true;
let trailFrames = [], currentWaveColor = "#00FF7F";
let canvas = $("waveCanvas"), ctx = canvas.getContext("2d");

// ... (The rest of your audio/MIDI engine goes here, with let/const for variables.)

// MIDI feedback
function showMidiFeedback() {
  midiIndicator.classList.add('active');
  clearTimeout(midiFeedbackTimeout);
  midiFeedbackTimeout = setTimeout(() => midiIndicator.classList.remove('active'), 200);
}

// Error handling for MIDI
function setupMidi() {
  if (!navigator.requestMIDIAccess) {
    alert("MIDI not supported in your browser.");
    return;
  }
  navigator.requestMIDIAccess().then(midi => {
    midiAccess = midi;
    // ... (rest of MIDI setup)
  }, err => {
    alert("Unable to access MIDI devices.");
    console.warn("No MIDI access", err);
  });
}

// Loading indicator for AudioContext
function initAudio() {
  showLoading(true);
  setTimeout(() => { // Simulate loading for demo; remove in production
    try {
      if (audioCtx) return;
      // ... (rest of your initAudio code)
      showLoading(false);
    } catch (e) {
      showLoading(false);
      alert("Failed to initialize audio context: " + e.message);
    }
  }, 500);
}

// Instrument data toggle
$("toggleDisplay").addEventListener("click", () => {
  infoDisplay.style.display = infoDisplay.style.display === "none" ? "block" : "none";
  if (infoDisplay.style.display !== "none") updateDisplay();
});

// Tooltips for all buttons
document.querySelectorAll('button[title]').forEach(btn => {
  btn.addEventListener('focus', e => btn.setAttribute('aria-label', btn.title));
  btn.addEventListener('blur', e => btn.removeAttribute('aria-label'));
});

// Keyboard shortcut: Space to play/pause
window.addEventListener('keydown', e => {
  if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT") return;
  if (e.key === " ") {
    if (stopped) $("play").click();
    else $("stop").click();
  }
});

</script>
</body>
</html>
